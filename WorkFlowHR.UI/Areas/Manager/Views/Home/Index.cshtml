@using Newtonsoft.Json
@using System.Collections.Generic
@{
    ViewData["Title"] = "Manager Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Fallback'lar
    var loginName = (ViewBag.LoginFirstName as string) ?? (User?.Identity?.Name ?? "Manager");
    int employeesCount = ViewBag.EmployeesCount is int ec ? ec : 0;
    int totalLeaves = ViewBag.TotalLeaves is int tl ? tl : 0;
    int totalAdvances = ViewBag.TotalAdvances is int ta ? ta : 0;

    var leaveCounts = ViewBag.LeaveCounts as IDictionary<string, int> ?? new Dictionary<string, int>();
    var advanceCounts = ViewBag.AdvanceCounts as IDictionary<string, int> ?? new Dictionary<string, int>();
    var expenseCounts = ViewBag.ExpenseCounts as IDictionary<string, int> ?? new Dictionary<string, int>();
}

<div class="container-fluid page-container py-4 px-4">
    <!-- Üst şerit -->
    <div class="neo-bar mb-4">
        <div class="d-flex align-items-center gap-3">
            <div class="neo-bubble"></div>
            <div>
                <div class="neo-eyebrow">Dashboard</div>
                <h2 class="mb-0">Welcome, <span class="highlight">@loginName</span> 👋</h2>
            </div>
        </div>
        <div class="text-right">
            <div id="clock" class="neo-clock">--:--</div>
            <div id="today" class="neo-date">-- -- ----</div>
        </div>
    </div>

    <!-- KPI Kartları -->
    <div class="row grid-gutter g-rows mb-2">
        <div class="col-12 col-lg-4">
            <div class="neo-card kpi kpi-a">
                <div class="kpi-label">Employee Count</div>
                <div class="kpi-value">@employeesCount</div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="neo-card kpi kpi-b">
                <div class="kpi-label">Total Leave</div>
                <div class="kpi-value">@totalLeaves</div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="neo-card kpi kpi-c">
                <div class="kpi-label">Total Advance</div>
                <div class="kpi-value">@totalAdvances</div>
            </div>
        </div>
    </div>

    <!-- 3 Grafik yan yana -->
    <div class="row grid-gutter g-rows">
        <div class="col-12 col-xl-4">
            <div class="neo-card section-card">
                <div class="neo-card-head">
                    <h5>
                        Leave Start Days
                    </h5>
                </div>
                <div class="neo-card-body">
                    <canvas id="chartLeaves" height="220"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-4">
            <div class="neo-card section-card">
                <div class="neo-card-head">
                    <h5>
                        Advance Days
                    </h5>
                </div>
                <div class="neo-card-body">
                    <canvas id="chartAdvances" height="220"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-4">
            <div class="neo-card section-card">
                <div class="neo-card-head">
                    <h5>Expense Days</h5>
                </div>
                <div class="neo-card-body">
                    <canvas id="chartExpenses" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

 
    <div class="row grid-gutter g-rows mt-2">
        <div class="col-12">
            <div class="neo-card section-card">
                <div class="neo-card-head d-flex align-items-center justify-content-between">
                    <h5>
                        Manager Calendar
                    </h5>
                    <div class="muted">Forthcoming Dates</div>
                </div>
                <div class="neo-card-body">
                    <div id="managerCalendar" class="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
  
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">

    <style>
        :root {
            --v: #7c3aed;
            --c: #06b6d4;
            --c2: #22d3ee;
            --ink: #0f172a;
            --glass: rgba(255,255,255,.7);
            --bd: rgba(2,6,23,.08);
            --shadow: 0 12px 28px rgba(2,6,23,.15);
            --r: 16px;
        }

        /* Sayfayı yatayda yay */
        .page-container {
            padding-left: clamp(16px, 2.2vw, 36px) !important;
            padding-right: clamp(16px, 2.2vw, 36px) !important;
        }

        /* Kolonlar arası ekstra boşluk (Bootstrap'ten bağımsız) */
        .grid-gutter {
            margin-left: -14px;
            margin-right: -14px;
        }

            .grid-gutter > [class*="col-"] {
                padding-left: 14px;
                padding-right: 14px;
            }
        /* Satırlar arası boşluk */
        .g-rows {
            row-gap: 22px;
        }

        .neo-bar {
            border: 1px solid var(--bd);
            border-radius: var(--r);
            background: linear-gradient(90deg, rgba(124,58,237,.08), rgba(6,182,212,.08));
            padding: 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .neo-bubble {
            width: 14px;
            height: 14px;
            border-radius: 999px;
            background: linear-gradient(90deg,var(--v),var(--c));
            box-shadow: 0 0 0 4px rgba(124,58,237,.18);
        }

        .neo-eyebrow {
            font-weight: 700;
            letter-spacing: .4px;
            color: var(--ink);
            opacity: .7;
            font-size: .9rem;
        }

        .highlight {
            background: linear-gradient(90deg,var(--v),var(--c));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .neo-clock {
            font-size: 1.7rem;
            font-weight: 800;
        }

        .neo-date {
            opacity: .8;
            font-weight: 600;
        }

        .neo-card {
            background: var(--glass);
            border: 1px solid var(--bd);
            border-radius: var(--r);
            box-shadow: var(--shadow);
        }

            .neo-card.section-card {
                padding: 6px;
            }
        /* kart dışına hafif nefes */
        .neo-card-head {
            padding: 12px 14px;
            border-bottom: 1px solid var(--bd);
            background: linear-gradient(90deg, rgba(124,58,237,.10), rgba(6,182,212,.10));
        }

            .neo-card-head h5 {
                margin: 0;
                font-weight: 800;
                color: var(--ink);
            }

        .neo-card-body {
            padding: 16px;
        }

        /* KPI */
        .kpi {
            position: relative;
            overflow: hidden;
            min-height: 120px;
            padding: 16px;
        }

            .kpi .kpi-label {
                font-weight: 700;
                opacity: .8;
                margin-bottom: 6px;
            }

            .kpi .kpi-value {
                font-size: 2.2rem;
                font-weight: 900;
            }

            .kpi:before {
                content: "";
                position: absolute;
                inset: auto -40px -40px auto;
                width: 160px;
                height: 160px;
                border-radius: 50%;
                filter: blur(40px);
                opacity: .65;
            }

        .kpi-a:before {
            background: radial-gradient(circle at center, rgba(124,58,237,.45), transparent 60%);
        }

        .kpi-b:before {
            background: radial-gradient(circle at center, rgba(6,182,212,.45), transparent 60%);
        }

        .kpi-c:before {
            background: radial-gradient(circle at center, rgba(34,211,238,.45), transparent 60%);
        }

        /* Takvim (jQuery UI inline) */
        .calendar .ui-datepicker {
            width: 100%;
            max-width: 1100px;
            margin: auto;
            border: 1px solid var(--bd) !important;
            border-radius: 12px;
            padding: 6px 8px !important;
            background: #fff !important;
            box-shadow: var(--shadow);
        }

        .calendar .ui-datepicker-header {
            border-radius: 10px;
            border: 1px solid var(--bd);
            background: linear-gradient(90deg, rgba(124,58,237,.10), rgba(6,182,212,.10)) !important;
        }

        .calendar .ui-state-default {
            border-radius: 8px !important;
            border: 1px solid transparent !important;
        }

        .calendar .ui-state-active, .calendar .ui-state-hover {
            border-color: rgba(124,58,237,.35) !important;
            background: rgba(124,58,237,.08) !important;
        }

        /* Büyük ekranlarda kartlar ve grafikler genişlesin */
        @@media (min-width:1400px) {
            .page-container

        {
            padding-left: 48px !important;
            padding-right: 48px !important;
        }

        .neo-card-body {
            padding: 18px;
        }

        }
    </style>
}

@section Scripts {
    <!-- jQuery UI (Takvim) -->
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // Saat & Tarih
        (function () {
            const $clock = document.getElementById('clock');
            const $today = document.getElementById('today');
            const days   = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];

            function tick() {
                const now = new Date();
                const hh = String(now.getHours()).padStart(2, '0');
                const mm = String(now.getMinutes()).padStart(2, '0');
                $clock.textContent = `${hh}:${mm}`;

                const dname = days[now.getDay()];
                const d     = String(now.getDate()).padStart(2, '0');
                const mname = months[now.getMonth()];
                const y     = now.getFullYear();
                $today.textContent = `${dname}, ${d} ${mname} ${y}`;
            }
            tick();
            setInterval(tick, 1000);
        })();

        // Takvim (inline)
        $(function () {
            $("#managerCalendar").datepicker({
                showOtherMonths: true,
                selectOtherMonths: true
            });
        });

        // Chart verileri (Server -> JS)
        const daysOfWeek = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];

        const leaveCounts   = @Html.Raw(JsonConvert.SerializeObject(leaveCounts));
        const advanceCounts = @Html.Raw(JsonConvert.SerializeObject(advanceCounts));
        const expenseCounts = @Html.Raw(JsonConvert.SerializeObject(expenseCounts));

        const dataLeaves   = daysOfWeek.map(d => leaveCounts[d]   ?? 0);
        const dataAdvances = daysOfWeek.map(d => advanceCounts[d] ?? 0);
        const dataExpenses = daysOfWeek.map(d => expenseCounts[d] ?? 0);

        // Chart seçenekleri
        const baseOptions = {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { left: 6, right: 6, top: 6, bottom: 6 } },
            scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            },
            plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
            }
        };

        // 1) Leaves (bar)
        new Chart(document.getElementById('chartLeaves'), {
            type: 'bar',
            data: {
                labels: daysOfWeek,
                datasets: [{ data: dataLeaves }]
            },
            options: baseOptions
        });

        // 2) Advances (line)
        new Chart(document.getElementById('chartAdvances'), {
            type: 'line',
            data: {
                labels: daysOfWeek,
                datasets: [{
                    data: dataAdvances,
                    fill: true,
                    tension: 0.25
                }]
            },
            options: baseOptions
        });

        // 3) Expenses (bar)
        new Chart(document.getElementById('chartExpenses'), {
            type: 'bar',
            data: {
                labels: daysOfWeek,
                datasets: [{ data: dataExpenses }]
            },
            options: baseOptions
        });
    </script>
}
