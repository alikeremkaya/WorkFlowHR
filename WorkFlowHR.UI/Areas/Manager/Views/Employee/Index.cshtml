@model IEnumerable<WorkFlowHR.UI.Areas.Manager.Models.EmployeeVMs.EmployeeListVM>
@using System
@using System.Security.Claims

@{
    ViewData["Title"] = "Employees";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js"></script>

<div class="page-head">
    <h1 class="page-title">Employees</h1>
</div>

<form id="__ajaxAntiForgeryForm" style="display:none">
    @Html.AntiForgeryToken()
</form>

<div class="employee-grid-container">
    <div class="employee-grid">
        @foreach (var item in Model)
        {
            <div class="employee-card">
                <div class="dropdown employee-actions">
                    <button class="btn btn-sm dropdown-toggle action-dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="ti-more-alt"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="@Url.Action("Index", "Summary", new { employeeId = item.Id })">Details</a></li>
                        <li><a class="dropdown-item" href="javascript:void(0);" onclick="openUpdatePhotoModal('@item.Id')">Update Photo</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item btn-delete-direct" data-id="@item.Id">Delete</button></li>
                    </ul>
                </div>

                <div class="employee-photo-container">
                    @if (item.Image == null || item.Image.Length == 0)
                    {
                        <div class="employee-photo-placeholder">
                            <span>@(string.IsNullOrWhiteSpace(item.AppUserDisplayName) ? "??" : item.AppUserDisplayName.Trim().Substring(0, 1).ToUpper())</span>
                        </div>
                    }
                    else
                    {
                        <img class="employee-photo" src="@($"data:image/png;base64,{Convert.ToBase64String(item.Image)}")" alt="photo" />
                    }
                </div>

                <div class="employee-details">
                    <div class="employee-name" title="@item.AppUserDisplayName">@item.AppUserDisplayName</div>
                    <div class="employee-email" title="@item.Email">@item.Email</div>
                    <div class="employee-role">
                        <span class="chip">@item.Roles</span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>


<div id="formModal" class="custom-modal-root" role="dialog" aria-modal="true">
    <div class="custom-modal-card" onclick="event.stopPropagation()">
        <button class="custom-close-button" onclick="closeModal('formModal')" aria-label="Close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div id="formModalContent" class="p-4"></div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        function getRequestVerificationToken() {
            return $('#__ajaxAntiForgeryForm input[name="__RequestVerificationToken"]').val();
        }

        $(function () {
            $(document).on('click', '.btn-delete-direct', function (e) {
                e.stopPropagation();
                const id = $(this).data('id');
                swal({
                    title: "Are you sure?",
                    text: "This action cannot be undone!",
                    icon: "warning",
                    buttons: {
                        cancel: { text: "Cancel", visible: true, className: "btn btn-secondary", closeModal: true },
                        confirm: { text: "Delete", className: "btn btn-danger", closeModal: false }
                    },
                    dangerMode: true,
                }).then((isConfirm) => {
                    if (!isConfirm) return;

                    $.ajax({
                        url: '@Url.Action("Delete", "Employee", new { area = "Manager" })',
                        type: 'POST',
                        data: { id: id },
                        headers: { 'RequestVerificationToken': getRequestVerificationToken() },
                        success: function () {
                            swal("Success!", "The employee has been deleted.", "success").then(() => location.reload());
                        },
                        error: function () {
                            swal("Error!", "An unexpected error occurred.", "error");
                        }
                    });
                });
            });

            $(document).on('click', '.custom-modal-root', function (e) {
                if (e.target === e.currentTarget) $(this).fadeOut(200);
            });
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') $('.custom-modal-root:visible').fadeOut(200);
            });
        });

        function openUpdatePhotoModal(id) {
            const url = '@Url.Action("UpdatePhoto", "Employee", new { area = "Manager" })' + '?id=' + encodeURIComponent(id);
             $.get(url, function (html) {
                $('#formModalContent').html(html);
                $('#formModal').fadeIn(200).css('display', 'flex');
            });
        }

        function closeModal(id) {
            $('#' + id).fadeOut(200);
        }
    </script>
}

@section Styles {
    <style>
        :root {
            --primary-color: #0d6efd;
            --primary-hover: #0b5ed7;
            --secondary-color: #6c757d;
            --text-color: #212529;
            --border-color: #dee2e6;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --danger-text: #842029;
            --radius-sm: 6px;
            --radius-md: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            background: var(--bg-light);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .page-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 24px 28px;
        }

        .page-title {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.75rem;
            margin: 0;
        }

        .employee-grid-container {
            padding: 0 1.5rem 1.5rem;
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .employee-card {
            position: relative;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md, 8px);
            overflow: hidden;
            transition: all 0.2s ease-in-out;
        }

            .employee-card:hover {
                transform: translateY(-4px);
                box-shadow: var(--shadow-md, 0 4px 6px -1px rgba(0,0,0,.1));
            }

        .employee-actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            z-index: 2;
        }

        .employee-photo-container {
            aspect-ratio: 1 / 1;
            background-color: var(--bg-light);
        }

        .employee-photo, .employee-photo-placeholder {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .employee-photo-placeholder {
            display: grid;
            place-items: center;
            font-size: 4rem;
            font-weight: 600;
            color: var(--secondary-color);
            background-color: #e9ecef;
        }

        .employee-details {
            padding: 1rem;
            text-align: center;
        }

        .employee-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .employee-email {
            color: var(--secondary-color);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.75rem;
        }

        .chip {
            display: inline-block;
            padding: .3rem .75rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: .75rem;
            line-height: 1;
            background-color: #e9ecef;
            color: #495057;
        }

        .action-dropdown-toggle {
            background-color: rgba(255,255,255,0.8);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.25rem 0.5rem;
        }

            .action-dropdown-toggle:hover, .action-dropdown-toggle:focus {
                background-color: var(--bg-white);
            }

            .action-dropdown-toggle::after {
                display: none;
            }

        .dropdown-menu {
            --bs-dropdown-min-width: 160px;
            --bs-dropdown-padding-y: 0.5rem;
            --bs-dropdown-font-size: 0.9rem;
            --bs-dropdown-border-radius: var(--radius-md, 8px);
            --bs-dropdown-link-hover-bg: var(--bg-light);
            box-shadow: var(--shadow-md, 0 4px 6px -1px rgba(0,0,0,.1));
        }

        .dropdown-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        .dropdown-item-delete {
            color: #842029 !important;
        }

            .dropdown-item-delete:hover {
                background-color: #f8d7da !important;
            }

        .dropdown-divider {
            margin: 0.5rem 0;
        }

        .custom-modal-root {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1050;
            background: rgba(33, 37, 41, 0.6);
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .custom-modal-card {
            width: min(560px, 92vw);
            background: var(--bg-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            position: relative;
            animation: modal-pop .2s ease-out;
        }

        @@keyframes modal-pop {
            from {
                transform: scale(.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .custom-close-button {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: transparent;
            color: var(--secondary-color);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .15s ease;
            z-index: 10;
        }

            .custom-close-button:hover {
                background-color: var(--bg-light);
            }
    </style>
}

