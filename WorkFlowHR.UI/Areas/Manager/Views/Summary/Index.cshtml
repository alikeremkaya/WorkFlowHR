@model WorkFlowHR.UI.Areas.Manager.Models.SummaryVMs.SummaryViewModel
@using WorkFlowHR.Domain.Enums

@{
    ViewData["Title"] = "Request Summary";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js"></script>

<div class="page-head">
    <h1 class="page-title">All Requests Summary</h1>
    <ul class="nav nav-tabs custom-tabs">
        <li class="nav-item">
            <a class="nav-link active" href="#" data-tab="advances">Advances</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="expenses">Expenses</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-tab="leaves">Leaves</a>
        </li>
    </ul>
</div>


<div>
    <div id="advances" class="tab-content" style="display:none;">
        <div class="table-container">
            <table id="advancesTable" class="display nowrap custom-table responsive" style="width:100%">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Employee</th>
                        <th>Amount</th>
                        <th>Request Date</th>
                        <th>Status</th>
                        <th>Role</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var a in Model.Advances)
                    {
                        var statusText = a.AdvanceStatus.ToString();
                        var statusClass =
                        statusText.Equals("Approved", StringComparison.OrdinalIgnoreCase) ? "status-pill-approved" :
                        statusText.Equals("Rejected", StringComparison.OrdinalIgnoreCase) ? "status-pill-rejected" :
                        "status-pill-pending";
                        <tr>
                            <td>
                                <div class="image-cell">
                                    @if (a.Image != null && a.Image.Length > 0)
                                    {
                                        var src = $"data:image/png;base64,{Convert.ToBase64String(a.Image)}";
                                        <img src="@src" class="image-preview" alt="Photo" data-bs-toggle="modal" data-bs-target="#imageZoomModal" data-bs-image-src="@src" />
                                    }
                                </div>
                            </td>
                            <td>@a.AppUserDisplayName</td>
                            <td>@($"{a.Amount:N2} ₺")</td>
                            <td>@a.AdvanceDate.ToShortDateString()</td>
                            <td><span class="status-pill @statusClass">@statusText</span></td>
                            <td>@a.Roles</td>
                            <td>
                                <a href="@Url.Action("Details","Advance", new { id = a.Id, area = "Manager" })" class="btn btn-sm btn-details">Details</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div id="expenses" class="tab-content" style="display:none;">
        <div class="table-container">
            <table id="expensesTable" class="display nowrap custom-table responsive" style="width:100%">
                <thead>
                    <tr>
                        <th>Receipt</th>
                        <th>Employee</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Role</th>
                        <th>Expense Date</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var e in Model.Expenses)
                    {
                        <tr>
                            <td>
                                <div class="image-cell">
                                    @if (e.Image != null && e.Image.Length > 0)
                                    {
                                        var src = $"data:image/png;base64,{Convert.ToBase64String(e.Image)}";
                                        <img src="@src" class="image-preview" alt="Receipt" data-bs-toggle="modal" data-bs-target="#imageZoomModal" data-bs-image-src="@src" />
                                    }
                                </div>
                            </td>
                            <td>@e.AppUserDisplayName</td>
                            <td>
                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="@e.Description">
                                    @(e.Description?.Length > 40 ? e.Description.Substring(0, 40) + "…" : e.Description)
                                </span>
                            </td>
                            <td>@($"{e.Amount:N2} ₺")</td>
                            <td>@e.Roles</td>
                            <td>@e.ExpenseDate.ToShortDateString()</td>
                            <td>
                                <a href="@Url.Action("Details","Expense", new { id = e.Id, area = "Manager" })" class="btn btn-sm btn-details">Details</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div id="leaves" class="tab-content" style="display:none;">
        <div class="table-container">
            <table id="leavesTable" class="display nowrap custom-table responsive" style="width:100%">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Leave Type</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var l in Model.Leaves)
                    {
                        var lStatus = l.LeaveStatus.ToString();
                        var lClass =
                        lStatus.Equals("Approved", StringComparison.OrdinalIgnoreCase) ? "status-pill-approved" :
                        lStatus.Equals("Rejected", StringComparison.OrdinalIgnoreCase) ? "status-pill-rejected" :
                        "status-pill-pending";
                        <tr>
                            <td>@l.AppUserDisplayName</td>
                            <td>@l.LeaveTypeName</td>
                            <td>@l.StartDate.ToShortDateString()</td>
                            <td>@l.EndDate.ToShortDateString()</td>
                            <td><span class="status-pill @lClass">@lStatus</span></td>
                            <td>
                                <a href="@Url.Action("Details","Leave", new { id = l.Id, area = "Manager" })" class="btn btn-sm btn-details">Details</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="imageZoomModal" tabindex="-1" aria-labelledby="imageZoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageZoomModalLabel">Full Size Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalZoomImage" src="" class="img-fluid rounded" alt="Full Size Image">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const TAB_KEY = "summary_selected_tab";

            function selectTab(tabId, pushState = true) {
                $('.tab-content').hide();
                $('#' + tabId).show();

                $('.custom-tabs .nav-link').removeClass('active');
                $(`.custom-tabs .nav-link[data-tab="${tabId}"]`).addClass('active');

                if (window.jQuery && $.fn.dataTable) {
                    if (tabId === 'advances' && !$.fn.DataTable.isDataTable('#advancesTable')) initTable('#advancesTable');
                    if (tabId === 'expenses' && !$.fn.DataTable.isDataTable('#expensesTable')) initTable('#expensesTable');
                    if (tabId === 'leaves' && !$.fn.DataTable.isDataTable('#leavesTable')) initTable('#leavesTable');
                }

                if (pushState) {
                     localStorage.setItem(TAB_KEY, tabId);
                }
            }

            function initTable(selector) {
                $(selector).DataTable({
                    paging: true,
                    searching: true,
                    ordering: true,
                    responsive: true,
                    order: [[3, 'desc']],
                    columnDefs: [{ targets: [0, -1], orderable: false, searchable: false }],
                    language: {
                        lengthMenu: "Show _MENU_ entries",
                        search: "_INPUT_",
                        searchPlaceholder: "Search records...",
                        paginate: { next: "Next", previous: "Previous" },
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoEmpty: "No entries to show",
                        emptyTable: "No data available"
                    }
                }).on('draw.dt', function() {
                    // Yeniden çizim sonrası tooltip'leri güncelle
                    $('[data-bs-toggle="tooltip"]').tooltip('dispose').tooltip();
                });
                // Başlangıçta da tooltip'leri başlat
                $('[data-bs-toggle="tooltip"]').tooltip();
            }

            $('.custom-tabs').on('click', '.nav-link', function (e) {
                e.preventDefault();
                selectTab($(this).data('tab'));
            });

            // Görüntü modalını açmak için olay dinleyici
            $('#imageZoomModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget); // Modalı tetikleyen element
                const imageSrc = button.data('bs-image-src'); // image-src data attribute'ından URL al
                const modalImage = $(this).find('#modalZoomImage');
                modalImage.attr('src', imageSrc);
            });

            const savedTab = localStorage.getItem(TAB_KEY) || 'advances';
            selectTab(savedTab, false);
        })();
    </script>
}

@section Styles {
    <style>
        .custom-tabs {
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 0;
        }

            .custom-tabs .nav-item {
                margin-bottom: -2px;
            }

            .custom-tabs .nav-link {
                border: none;
                border-bottom: 2px solid transparent;
                color: var(--secondary-color);
                font-weight: 500;
                padding: 0.75rem 1.25rem;
                transition: all 0.2s ease;
            }

                .custom-tabs .nav-link:hover {
                    color: var(--primary-hover);
                }

                .custom-tabs .nav-link.active {
                    color: var(--primary-color);
                    background-color: transparent;
                    border-bottom-color: var(--primary-color);
                    font-weight: 600;
                }

        .btn-details {
            background-color: var(--bg-light);
            color: var(--text-color);
            font-weight: 500;
            border: 1px solid var(--border-color);
            transition: all 0.15s ease;
            padding: .25rem .75rem;
            border-radius: var(--radius-sm);
        }

            .btn-details:hover {
                background-color: #e9ecef;
                border-color: #adb5bd;
                transform: translateY(-1px);
            }

        .status-pill {
            display: inline-block;
            padding: .25em .6em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: .25rem;
        }

        .status-pill-approved {
            color: #0f5132;
            background-color: #d1e7dd;
        }

        .status-pill-rejected {
            color: #842029;
            background-color: #f8d7da;
        }

        .status-pill-pending {
            color: #664d03;
            background-color: #fff3cd;
        }

        .image-cell .image-preview {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%; /* Yuvarlak hale getirir */
            border: 2px solid var(--bg-white);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

            .image-cell .image-preview:hover {
                transform: scale(1.1);
            }

        /* Bootstrap Modal özelleştirmeleri */
        #imageZoomModal .modal-content {
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
        }

        #imageZoomModal .modal-header {
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
        }

        #imageZoomModal .modal-title {
            font-weight: 600;
            color: var(--text-color);
        }

        #imageZoomModal .modal-body {
            padding: 1.5rem;
        }

        #modalZoomImage {
            max-height: 80vh; /* Ekran yüksekliğinin %80'ini geçmez */
            width: auto;
            display: block;
            margin: auto;
        }
    </style>
}