@model IEnumerable<WorkFlowHR.UI.Areas.Manager.Models.ExpenseVMs.ExpenseListVM>
@using WorkFlowHR.Domain.Enums

@{
    ViewData["Title"] = "Expense Requests";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


<div class="page-head">
    <h1 class="page-title">Expense Requests</h1>
    <a href="javascript:void(0);" class="btn btn-primary-custom" onclick="openCreateModal()">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" style="margin-right: 6px;"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
        Create for Employee
    </a>
</div>

<form id="__ajaxAntiForgeryForm" style="display:none">
    @Html.AntiForgeryToken()
</form>

<div class="table-container">
    <table id="expensesTable" class="display nowrap custom-table responsive" style="width:100%">
        <thead>
            <tr>
                <th class="text-center">Receipt</th>
                <th>Employee</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Expense Date</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                var desc = item.Description ?? string.Empty;
                var shortDesc = desc.Length > 40 ? desc.Substring(0, 40) + "..." : desc;
                <tr>
                    <td>
                        <div class="image-cell">
                            @if (item.Image is null || item.Image.Length == 0)
                            {
                                <div class="image-placeholder">No Receipt</div>
                            }
                            else
                            {
                                var imageSrc = $"data:image/png;base64,{Convert.ToBase64String(item.Image)}";
                                <img class="image-preview" src="@imageSrc" alt="receipt" onclick="openImageModal('@imageSrc')" />
                            }
                        </div>
                    </td>
                    <td>@item.AppUserDisplayName</td>
                    <td>
                        <span data-bs-toggle="tooltip" data-bs-placement="top" title="@desc">@shortDesc</span>
                    </td>
                    <td>@($"{item.Amount:N2} ₺")</td>
                    <td>@item.ExpenseDate.ToString("dd MMMM yyyy")</td>
                    <td class="text-center">
                        <div class="dropdown">
                            <button class="btn btn-sm dropdown-toggle action-dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                    <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
                                </svg>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="openUpdateModal('@item.Id')">Update</a></li>
                                <li>
                                    <button class="dropdown-item btn-delete-direct" data-action="Delete" data-id="@item.Id" data-title="Delete Request?" data-text="Once deleted, you will not be able to recover this expense request!" data-success="The request has been deleted.">Delete</button>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div id="createModal" class="custom-modal-root" role="dialog" aria-modal="true">
    <div class="custom-modal-card" onclick="event.stopPropagation()">
        <button class="custom-close-button" onclick="closeModal('createModal')" aria-label="Close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div id="createModalContent" class="p-4"></div>
    </div>
</div>

<div id="updateModal" class="custom-modal-root" role="dialog" aria-modal="true">
    <div class="custom-modal-card" onclick="event.stopPropagation()">
        <button class="custom-close-button" onclick="closeModal('updateModal')" aria-label="Close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div id="updateModalContent" class="p-4"></div>
    </div>
</div>

<div id="imageModal" class="custom-modal-root" role="dialog" aria-modal="true">
    <div class="custom-modal-card image-zoom-card" onclick="event.stopPropagation()">
        <button class="custom-close-button" onclick="closeModal('imageModal')" aria-label="Close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <img id="modal-image" alt="Full-size receipt" />
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        function getRequestVerificationToken() {
            return $('#__ajaxAntiForgeryForm input[name="__RequestVerificationToken"]').val();
        }

        function handleAjaxAction(actionName, id, confirmTitle, confirmText, successText) {
            swal({
                title: confirmTitle,
                text: confirmText,
                icon: "warning",
                buttons: {
                    cancel: { text: "Cancel", visible: true, className: "btn btn-secondary", closeModal: true },
                    confirm: { text: "Confirm", className: "btn btn-primary-custom", closeModal: false }
                },
            }).then((isConfirm) => {
                if (!isConfirm) return;
                $.ajax({
                    url: `@Url.Action(null, "Expense", new { area = "Manager" })/` + actionName,
                    type: 'POST',
                    data: { id: id },
                    headers: { 'RequestVerificationToken': getRequestVerificationToken() },
                    success: function(response) {
                        if (response.success) {
                            swal("Success!", successText, "success").then(() => location.reload());
                        } else {
                            swal("Error!", response.message || "An unexpected error occurred.", "error");
                        }
                    },
                    error: function() {
                        swal("Error!", "An unexpected error occurred.", "error");
                    }
                });
            });
        }

        // Event listener (Mevcut)
        $(document).on('click', '.dropdown-item', function() {
            var button = $(this);
            var actionName = button.data('action');
            if (actionName) {
                var id = button.data('id');
                var title = button.data('title');
                var text = button.data('text');
                var successMessage = button.data('success');
                handleAjaxAction(actionName, id, title, text, successMessage);
            }
        });

        // YENİ: Tekli takvimi başlatan fonksiyon
        function initializeDatepicker() {
            // Not: Bu fonksiyonun çalışması için partial view'daki input'un id'sinin 'ExpenseDate' olması gerekir.
            let dateInput = document.querySelector("#ExpenseDate");
            if (dateInput) {
                flatpickr(dateInput, {
                    dateFormat: "Y-m-d",      // Sunucuya gönderilecek format
                    altInput: true,           // Kullanıcıya gösterilecek alternatif input
                    altFormat: "d F Y",       // Kullanıcıya gösterilecek format
                    allowInput: true
                });
            }
        }

        $(function() {
            $('#expensesTable').DataTable({
                paging: true, searching: true, ordering: true, responsive: true, order: [[4, 'desc']],
                columnDefs: [{ targets: [0, -1], orderable: false, searchable: false }],
                language: {
                    lengthMenu: "Show _MENU_ entries", search: "_INPUT_", searchPlaceholder: "Search records...",
                    paginate: { next: "Next", previous: "Previous" },
                    info: "Showing _START_ to _END_ of _TOTAL_ entries", infoEmpty: "No entries to show", emptyTable: "No data available"
                }
            });

            // Tooltip başlatma (Mevcut)
            $('[data-bs-toggle="tooltip"]').tooltip();
            $('#expensesTable').on('draw.dt', function () {
                $('[data-bs-toggle="tooltip"]').tooltip('dispose').tooltip();
            });

            // Modal Kapatma Mantığı (Mevcut)
            $(document).on('click', '.custom-modal-root', function(e) {
                if (e.target === e.currentTarget) $(this).fadeOut(200);
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') $('.custom-modal-root:visible').fadeOut(200);
            });
        });

        // Modal Açma Fonksiyonları (Güncellendi)
        function openCreateModal() {
            $.get('@Url.Action("Create", "Expense", new { area = "Manager" })', function(html) {
                $('#createModalContent').html(html);
                $('#createModal').fadeIn(200).css('display', 'flex');
                initializeDatepicker(); // Takvimi başlat
                $.validator.unobtrusive.parse('#createModalContent');
            });
        }

        function openUpdateModal(id) {
            const url = '@Url.Action("Update", "Expense", new { area = "Manager" })' + '?id=' + encodeURIComponent(id);
            $.get(url, function(html) {
                $('#updateModalContent').html(html);
                $('#updateModal').fadeIn(200).css('display', 'flex');
                initializeDatepicker(); // Takvimi başlat
                $.validator.unobtrusive.parse('#updateModalContent');
            });
        }

        function openImageModal(src) {
            $('#modal-image').attr('src', src);
            $('#imageModal').fadeIn(200).css('display', 'flex');
        }

        function closeModal(id) {
            $('#' + id).fadeOut(200);
        }
    </script>
}

@section Styles {
    <style>
        :root {
            --primary-color: #0d6efd;
            --primary-hover: #0b5ed7;
            --secondary-color: #6c757d;
            --text-color: #212529;
            --border-color: #dee2e6;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --success-bg: #d1e7dd;
            --success-text: #0f5132;
            --warning-bg: #fff3cd;
            --warning-text: #664d03;
            --danger-bg: #f8d7da;
            --danger-text: #842029;
            --radius-sm: 6px;
            --radius-md: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            background: var(--bg-light);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .page-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 24px 28px;
        }

        .page-title {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.75rem;
            margin: 0;
        }

        .btn-primary-custom {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: 500;
            border: 1px solid var(--primary-color);
            border-radius: var(--radius-sm);
            padding: 10px 20px;
            text-decoration: none;
            transition: all .15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

            .btn-primary-custom:hover {
                background-color: var(--primary-hover);
                border-color: var(--primary-hover);
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }

        .table-container {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            margin: 0 28px 28px;
        }

        table.custom-table {
            width: 100%;
            border-collapse: collapse;
        }

            table.custom-table thead th {
                background-color: var(--bg-light);
                color: var(--secondary-color);
                font-weight: 600;
                font-size: 0.8rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border: none;
                padding: 12px 15px;
                text-align: left;
                border-bottom: 2px solid var(--border-color);
            }

            table.custom-table tbody td {
                background: var(--bg-white);
                padding: 12px 15px;
                border-bottom: 1px solid var(--border-color);
                vertical-align: middle;
                font-weight: 500;
            }

            table.custom-table tbody tr:last-child td {
                border-bottom: none;
            }

            table.custom-table tbody tr:hover {
                background-color: var(--bg-light);
            }

        .action-dropdown-toggle {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--secondary-color);
            padding: 0.25rem 0.5rem;
        }

            .action-dropdown-toggle:hover,
            .action-dropdown-toggle:focus {
                background-color: var(--bg-light);
                color: var(--text-color);
            }

            .action-dropdown-toggle::after {
                display: none;
            }

        .dropdown-menu {
            --bs-dropdown-min-width: 160px;
            --bs-dropdown-padding-y: 0.5rem;
            --bs-dropdown-font-size: 0.9rem;
            --bs-dropdown-border-radius: var(--radius-md, 8px);
            --bs-dropdown-link-hover-bg: var(--bg-light);
            box-shadow: var(--shadow-md, 0 4px 6px -1px rgba(0, 0, 0, .1));
        }

        .dropdown-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        .dropdown-item-approve {
            color: var(--success-text) !important;
        }

            .dropdown-item-approve:hover {
                background-color: var(--success-bg) !important;
            }

        .dropdown-item-reject,
        .dropdown-item-delete {
            color: var(--danger-text) !important;
        }

            .dropdown-item-reject:hover,
            .dropdown-item-delete:hover {
                background-color: var(--danger-bg) !important;
            }

        .dropdown-divider {
            margin: 0.5rem 0;
        }

        .image-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 60px;
        }

        .image-preview {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--bg-white);
            box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
            cursor: zoom-in;
            transition: transform 0.2s ease;
        }

            .image-preview:hover {
                transform: scale(1.1);
            }

        .image-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-light);
            color: var(--secondary-color);
            font-size: .7rem;
            border: 1px dashed var(--border-color);
        }

        .custom-modal-root {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1050;
            background: rgba(33, 37, 41, 0.6);
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .custom-modal-card {
            width: min(560px, 92vw);
            background: var(--bg-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            position: relative;
            animation: modal-pop .2s ease-out;
        }

        @@keyframes modal-pop {
            from {
                transform: scale(.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .custom-close-button {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: transparent;
            color: var(--secondary-color);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .15s ease;
            z-index: 10;
        }

            .custom-close-button:hover {
                background-color: var(--bg-light);
            }

        .image-zoom-card {
            width: auto;
            max-width: 90vw;
            max-height: 90vh;
            padding: 0;
            background: transparent;
            box-shadow: none;
            overflow: hidden;
        }

            .image-zoom-card img {
                display: block;
                max-width: 100%;
                max-height: 90vh;
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-md);
            }

            .image-zoom-card .custom-close-button {
                background-color: rgba(0, 0, 0, 0.4);
                color: white;
            }

                .image-zoom-card .custom-close-button:hover {
                    background-color: rgba(0, 0, 0, 0.6);
                }

        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 20px;
            color: var(--text-color);
        }

            .dataTables_wrapper .dataTables_length label,
            .dataTables_wrapper .dataTables_filter label {
                font-weight: 500;
            }

            .dataTables_wrapper .dataTables_length select,
            .dataTables_wrapper .dataTables_filter input {
                border: 1px solid var(--border-color);
                border-radius: var(--radius-sm);
                padding: 8px 12px;
                margin-left: 8px;
                transition: all .15s ease;
            }

                .dataTables_wrapper .dataTables_length select:focus,
                .dataTables_wrapper .dataTables_filter input:focus {
                    border-color: var(--primary-color);
                    outline: 0;
                    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25);
                }

        .dataTables_wrapper .dataTables_filter {
            text-align: right;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 50% !important;
            margin: 0 2px !important;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

            .dataTables_wrapper .dataTables_paginate .paginate_button.current,
            .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
                background: var(--primary-color) !important;
                color: white !important;
                border-color: var(--primary-color) !important;
            }

        .dataTables_wrapper .dataTables_info {
            padding-top: .85em;
        }
    </style>
}